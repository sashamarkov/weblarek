# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Vite

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/main.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
# Интернет-магазин «Web-Larёk»
«Web-Larёk» — это интернет-магазин с товарами для веб-разработчиков, где пользователи могут просматривать товары, добавлять их в корзину и оформлять заказы. Сайт предоставляет удобный интерфейс с модальными окнами для просмотра деталей товаров, управления корзиной и выбора способа оплаты, обеспечивая полный цикл покупки с отправкой заказов на сервер.

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP (Model-View-Presenter), которая обеспечивает четкое разделение ответственности между классами слоев Model и View. Каждый слой несет свой смысл и ответственность:

**Model** - слой данных, отвечает за хранение и изменение данных.  
**View** - слой представления, отвечает за отображение данных на странице.  
**Presenter** - презентер содержит основную логику приложения и  отвечает за связь представления и данных.

Взаимодействие между классами обеспечивается использованием событийно-ориентированного подхода. Модели и Представления генерируют события при изменении данных или взаимодействии пользователя с приложением, а Презентер обрабатывает эти события используя методы как Моделей, так и Представлений.

### Базовый код

#### Класс Component
Является базовым классом для всех компонентов интерфейса.
Класс является дженериком и принимает в переменной `T` тип данных, которые могут быть переданы в метод `render` для отображения.

**Конструктор:**
- `constructor(container: HTMLElement)` - принимает ссылку на DOM элемент за отображение, которого он отвечает.

**Поля класса:**  
- `container: HTMLElement` - поле для хранения корневого DOM элемента компонента.

**Методы класса:**
- `render(data?: Partial<T>): HTMLElement` - Главный метод класса. Он принимает данные, которые необходимо отобразить в интерфейсе, записывает эти данные в поля класса и возвращает ссылку на DOM-элемент. Предполагается, что в классах, которые будут наследоваться от `Component` будут реализованы сеттеры для полей с данными, которые будут вызываться в момент вызова `render` и записывать данные в необходимые DOM элементы.  
- `setImage(element: HTMLImageElement, src: string, alt?: string): void` - утилитарный метод для модификации DOM-элементов `<img>`

#### Класс Api
Содержит в себе базовую логику отправки запросов.

**Конструктор:**
- `constructor(baseUrl: string, options: RequestInit = {})` - В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

**Поля класса:**
- `baseUrl: string` - базовый адрес сервера  
- `options: RequestInit` - объект с заголовками, которые будут использованы для запросов.

**Методы:**
- `get(uri: string): Promise<object>` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер  
- `post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise<object>` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.  
- `handleResponse(response: Response): Promise<object>` - защищенный метод проверяющий ответ сервера на корректность и возвращающий объект с данными полученный от сервера или отклоненный промис, в случае некорректных данных.

#### Класс EventEmitter
Брокер событий реализует паттерн "Наблюдатель", позволяющий отправлять события и подписываться на события, происходящие в системе. Класс используется для связи слоя данных и представления.

Конструктор класса не принимает параметров.

**Поля класса:**
- `_events: Map<string | RegExp, Set<Function>>)` -  хранит коллекцию подписок на события. Ключи коллекции - названия событий или регулярное выражение, значения - коллекция функций обработчиков, которые будут вызваны при срабатывании события.

**Методы класса:**
- `on<T extends object>(event: EventName, callback: (data: T) => void): void` - подписка на событие, принимает название события и функцию обработчик.  
- `emit<T extends object>(event: string, data?: T): void` - инициализация события. При вызове события в метод передается название события и объект с данными, который будет использован как аргумент для вызова обработчика.  
- `trigger<T extends object>(event: string, context?: Partial<T>): (data: T) => void` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие с передачей в него данных из второго параметра.

## Данные

### Интерфейсы данных

#### Товар (Product)
```typescript
interface Product {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
}
```
**Назначение:** Описывает структру товара в каталоге интернет-магазина. Содержит всю необходимую информацию для отображения и работы с товаром.

#### Покупатель (OrderData)
```typescript
interface OrderData {
  payment: 'card' | 'cash' | '';
  email: string;
  phone: string;
  address: string;
}
```
**Назначение:** Описывает данные покупателя, необходимые для оформления заказа. Включает контактную информацию и способ оплаты.

## Модели данных

### Класс ProductCollection

**Назначение:** Отвечает за хранение и управление каталогом товаров. Обеспечивает доступ к списку товаров и выбранному товару для детального просмотра.

**Конструктор:**
```typescript
constructor()
```
Не принимает параметров, инициализирует пустые коллекции товаров.

**Поля класса:**
- `products: Product[]` - массив всех доступных товаров
- `selectedProduct: Product | null` - товар, выбранный для подробного отображения

**Методы класса:**
- `setProducts(products: Product[]): void` - сохраняет массив товаров, полученный в параметрах
- `getProducts(): Product[]` - возвращает массив всех товаров
- `getProductById(id: string): Product | undefined` - возвращает товар по его идентификатору
- `setSelectedProduct(product: Product): void` - сохраняет товар для подробного отображения
- `getSelectedProduct(): Product | null` - возвращает выбранный для детального просмотра товар

### Класс ShoppingCart

**Назначение:** Управляет корзиной покупок. Отвечает за добавление, удаление товаров и расчет общей стоимости.

**Конструктор:**
```typescript
constructor()
```
Инициализирует пустую корзину.

**Поля класса:**
- `items: Product[]` - массив товаров, выбранных для покупки

**Методы класса:**
- `getItems(): Product[]` - возвращает массив товаров в корзине
- `addItem(product: Product): void` - добаляет товар в корзину
- `removeItem(id: string): void` - удаляет товар из корзины по идентификатору
- `clear(): void` - полностью очищает корзину
- `getTotalPrice(): number` - вычисляет общую стоимость всех товаров в корзине
- `getItemsCount(): number` - возвращает общее количество товаров в корзине
- `hasItem(id: string): boolean` - проверяет наличие товара в корзине по идентификатору

### Класс OrderManager

**Назначение:** Управляет данными покупателя при оформлении заказа. Обеспечивает сохранение информации о заказе, валидацию и формирование запроса для API.

**Конструктор:**
```typescript
constructor()
```
Инициализирует пустые данные заказа.

**Поля класса:**
- `orderData: OrderData` - объект с данными покупателя

**Методы класса:**
- `setPayment(payment: 'card' | 'cash'): void` - сохраняет способ оплаты
- `setAddress(address: string): void` - сохраняет адрес доставки
- `setEmail(email: string): void` - сохраняет email покупателя
- `setPhone(phone: string): void` - сохраняет телефон покупателя
- `getOrderData(): OrderData` - возвращает все данные покупателя
- `clear(): void` - очищает все данные покупателя
- `validate(): ValidationResult` - проверяет валидность данных
- `createRequest(cart: ShoppingCart): OrderRequest` - создает объект запроса для API на основе текущих данных и корзины товаров

**Подробное описание createRequest:**

Метод createRequest формирует объект OrderRequest для отправки на сервер, объединяя данные покупателя из текущего экземпляра OrderManager с информацией о товарах из корзины.

**Параметры:**

`cart: ShoppingCart` - экземпляр корзины с товарами

**Возвращает:**

`OrderRequest` - объект с полными данными для отправки заказа

**Логика работы:**

1. Проверяет валидность текущих данных покупателя
2. Проверяет, что корзина не пуста
3. Формирует объект запроса с полями:
- payment - способ оплаты из orderData
- email, phone, address - контактные данные
- total - общая стоимость из корзины
- items - массив ID товаров из корзины

**Пример использования:**

```typescript
const orderManager = new OrderManager();
orderManager.setPayment('card');
orderManager.setEmail('user@example.com');
orderManager.setPhone('+79161234567');
orderManager.setAddress('ул. Ленина, д. 1');

const shoppingCart = new ShoppingCart();
shoppingCart.addItem(product1);
shoppingCart.addItem(product2);

// Формируем запрос для API
const orderRequest = orderManager.createRequest(shoppingCart);

// Отправляем на сервер
const response = await appAPI.submitOrder(orderRequest);
```

**Ошибки:**

- Выбрасывает ошибку, если данные покупателя не прошли валидацию
- Выбрасывает ошибку, если корзина пуста

**Интерфейс валидации:**
```typescript
interface ValidationResult {
  payment?: string;
  email?: string;
  phone?: string;
  address?: string;
}
```
Метод `validate()` возвращает объект, где ключи - названия полей, а значения - это тексты ошибок. Если поле валидно, оно отсутствует в объекте.

## Слой коммуникации

### Класс AppAPI

**Назначение:** Отвечает за взаимодействие с сервером API. Обеспечивает получение данных о товарах и отправку заказов на сервер.

**Конструктор:**
```typescript
constructor(api: IApi)
```

Принимает объект, соответствующий интерфейсу IApi, для выполнения HTTP-запросов.

**Методы класса:**

- getProductList(): Promise<Product[]> - выполняет GET-запрос на эндпоинт /product/ и возвращает массив товаров
- submitOrder(orderData: OrderRequest): Promise<void> выполняет POST запрос на эндпоинт /order/ и передаёт данные заказа

**Типы данных для API:**

```typescript
interface OrderRequest {
  payment: 'card' | 'cash';
  email: string;
  phone: string;
  address: string;
  total: number;
  items: string[];
}
```

## Слой Представления (View)

Классы слоя представления отвечают за отображение данных на странице и взаимодействие с пользователем. Каждый класс соответствует определённому блоку разметки и генерирует события в ответ на действия пользователя.

### Базовые классы

#### Класс Card (абстрактный)
**Назначение:** Базовый класс для всех типов карточек товаров. Выносит общий функционал для работы с элементами карточки.

**Конструктор:**
```typescript
constructor(container: HTMLElement)
```
Принимает корневой DOM-элемент карточки.

**Поля класса:**
- `container: HTMLElement` - корневой элемент карточки

**Методы класса:**
- `setTitle(title: string): void` - устанавливает заголовок карточки
- `setImage(src: string, alt?: string): void` - устанавливает изображение товара
- `setPrice(price: number | null): void` - устанавливает цену товара (форматирует в "XXX синапсов")
- `setCategory(category: string): void` - устанавливает категорию товара с правильным модификатором класса из `categoryMap`
- `setIndex(index: number): void` - устанавливает порядковый номер (для корзины)
- `setDescription(description: string): void` - устанавливает описание товара (для детального просмотра)
- `toggleButton(state: {label: string, disabled: boolean}): void` - изменяет состояние кнопки действия

#### Класс Form (абстрактный)
**Назначение:** Базовый класс для всех форм. Выносит общий функционал для работы с формами ввода.

**Конструктор:**
```typescript
constructor(container: HTMLElement)
```
Принимает корневой DOM-элемент формы.

**Поля класса:**
- `container: HTMLElement` - корневой элемент формы
- `_submitButton: HTMLButtonElement` - кнопка отправки формы
- `_errors: HTMLElement` - элемент для отображения ошибок

**Методы класса:**
- `setValid(valid: boolean): void` - активирует/деактивирует кнопку отправки
- `setErrors(errors: object): void` - отображает ошибки валидации
- `clear(): void` - очищает поля формы
- `findInput(name: string): HTMLInputElement` - вспомогательный метод для поиска поля ввода

### Классы карточек товаров

#### Класс CatalogCard
**Назначение:** Отображает товар в каталоге на главной странице. Использует шаблон `#card-catalog`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'card:select'` - генерируется при клике на карточку. В данных события передаётся `id` товара.

**Методы класса:**
Наследует все методы базового класса `Card`. Дополнительных методов не требует.

#### Класс PreviewCard
**Назначение:** Отображает детальную информацию о товаре в модальном окне. Использует шаблон `#card-preview`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'card:add'` - генерируется при клике на кнопку "В корзину". В данных события передаётся `id` товара.
- `'card:remove'` - генерируется при клике на кнопку "Удалить из корзины". В данных события передаётся `id` товара.

**Особенности:**
- Кнопка меняет состояние в зависимости от наличия товара в корзине
- Если цена товара `null`, кнопка блокируется с текстом "Недоступно"

#### Класс BasketCard
**Назначение:** Отображает товар в списке корзины. Использует шаблон `#card-basket`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'basket:remove'` - генерируется при клике на кнопку удаления товара. В данных события передаётся `id` товара.

**Методы класса:**
Наследует все методы базового класса `Card`. Требует установки порядкового номера через `setIndex()`.

### Классы форм

#### Класс BasketView
**Назначение:** Отображает корзину покупок. Использует шаблон `#basket`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'basket:order'` - генерируется при клике на кнопку "Оформить"

**Методы класса:**
- `setItems(items: HTMLElement[]): void` - устанавливает список товаров в корзину
- `setTotal(price: number): void` - устанавливает общую сумму корзины
- `setEmpty(state: boolean): void` - отображает состояние пустой корзины
- `toggleButton(state: boolean): void` - активирует/деактивирует кнопку оформления

#### Класс OrderForm
**Назначение:** Форма выбора способа оплаты и ввода адреса доставки. Использует шаблон `#order`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'order:submit'` - генерируется при отправке формы с валидными данными
- `'order.payment:change'` - генерируется при изменении способа оплаты
- `'order.address:change'` - генерируется при изменении адреса доставки

**Методы класса:**
- `setPayment(method: 'card' | 'cash'): void` - устанавливает выбранный способ оплаты
- `setAddress(address: string): void` - устанавливает адрес доставки
- `getValue(): {payment: string, address: string}` - возвращает текущие значения формы

#### Класс ContactsForm
**Назначение:** Форма ввода контактных данных (email и телефон). Использует шаблон `#contacts`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'contacts:submit'` - генерируется при отправке формы с валидными данными
- `'contacts.email:change'` - генерируется при изменении email
- `'contacts.phone:change'` - генерируется при изменении телефона

**Методы класса:**
- `setEmail(email: string): void` - устанавливает email
- `setPhone(phone: string): void` - устанавливает телефон
- `getValue(): {email: string, phone: string}` - возвращает текущие значения формы

### Дополнительные классы

#### Класс SuccessView
**Назначение:** Отображает сообщение об успешном оформлении заказа. Использует шаблон `#success`.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер и опционально брокер событий.

**События:**
- `'success:close'` - генерируется при клике на кнопку "За новыми покупками!"

**Методы класса:**
- `setTotal(price: number): void` - устанавливает сумму списанных синапсов

#### Класс Modal
**Назначение:** Управляет модальным окном. Работает с элементом `#modal-container`.

**Конструктор:**
```typescript
constructor(container: HTMLElement)
```
Принимает контейнер модального окна.

**Методы класса:**
- `open(content?: HTMLElement): void` - открывает модальное окно с переданным содержимым
- `close(): void` - закрывает модальное окно

**Особенности:**
- Не является компонентом в полном смысле, не наследуется от `Component`
- Закрывается по клику на крестик или вне окна
- Блокирует скроллинг страницы при открытии

#### Класс Page
**Назначение:** Управляет главной страницей приложения.

**Конструктор:**
```typescript
constructor(container: HTMLElement)
```
Принимает контейнер главной страницы.

**Методы класса:**
- `setGallery(items: HTMLElement[]): void` - отображает каталог товаров в галерее

#### Класс Header
**Назначение:** Управляет шапкой сайта.

**Конструктор:**
```typescript
constructor(container: HTMLElement, events?: IEvents)
```
Принимает контейнер header и опционально брокер событий.

**События:**
- `'header:basket'` - генерируется при клике на иконку корзины в шапке

**Методы класса:**
- `setCounter(count: number): void` - обновляет счётчик товаров в корзине

---

### События приложения

#### События от моделей данных:
1. **`'products:changed'`** - генерируется при изменении каталога товаров
2. **`'product:selected'`** - генерируется при выборе товара для детального просмотра
3. **`'basket:changed'`** - генерируется при изменении содержимого корзины
4. **`'order:changed'`** - генерируется при изменении данных покупателя

#### События от представлений:
1. **`'card:select'`** - выбор карточки товара для просмотра (передаётся `id`)
2. **`'card:add'`** - добавление товара в корзину (передаётся `id`)
3. **`'card:remove'`** - удаление товара из корзины (передаётся `id`)
4. **`'basket:remove'`** - удаление товара из корзины (в контексте корзины, передаётся `id`)
5. **`'header:basket'`** - открытие корзины
6. **`'basket:order'`** - начало оформления заказа
7. **`'order:submit'`** - переход ко второму шагу оформления
8. **`'contacts:submit'`** - завершение оформления заказа
9. **`'order.payment:change'`** - изменение способа оплаты
10. **`'order.address:change'`** - изменение адреса доставки
11. **`'contacts.email:change'`** - изменение email
12. **`'contacts.phone:change'`** - изменение телефона
13. **`'success:close'`** - закрытие окна успешного заказа

# Тестирование

## Уровни тестов

### 1. Unit тесты
**Что проверяют:** Логику моделей данных  
**Компоненты:** ProductCollection, ShoppingCart, OrderManager  
**Задачи:** 
- Работа с товарами и корзиной
- Валидация данных заказа
- Формирование запросов к API

### 2. Интеграционные тесты  
**Что проверяют:** Работу с API сервером  
**Сценарии:**
- Получение товаров
- Оформление заказа
- Обработка дубликатов товаров

### 3. E2E тесты
**Что проверяют:** Весь пользовательский сценарий  
**Сценарии:**
- Загрузка страницы и товаров
- Работа с корзиной
- Полное оформление заказа
- Управление модальными окнами

## Как запустить

### Из браузера (консоль):
```javascript
window.runTests(window.TestType.UNIT);  // Unit тесты
window.runTests(window.TestType.E2E);   // E2E тесты
window.runTests();                      // Все тесты
```

### Через URL:
```
http://localhost:5173/?test=unit    # Unit тесты
http://localhost:5173/?test=e2e     # E2E тесты  
http://localhost:5173/?test=all     # Все тесты
```

### Из кода:
```typescript
import { runTests, TestType } from './tests';

runTests(TestType.E2E);  // E2E тесты
```

## Структура
```
tests/
├── unit.test.ts          # Unit тесты моделей
├── integration.test.ts   # Тесты API
├── e2e.test.ts          # Тесты интерфейса
└── index.ts             # Менеджер тестов
```

## Особенности
- E2E тесты ждут загрузку страницы
- Интеграционные тесты проверяют связь с сервером
- Unit тесты работают без зависимостей
- Все результаты логируются в консоль

Тесты помогают находить ошибки на всех уровнях приложения.
